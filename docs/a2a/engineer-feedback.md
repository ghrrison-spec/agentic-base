# Sprint 1 Review Feedback

**Sprint:** Sprint 1 - Google Workspace Foundation
**Reviewer:** Senior Technical Lead
**Review Date:** 2025-12-12
**Verdict:** CHANGES REQUIRED

---

## Summary

3 of 4 tasks pass review. Task 1.3 (Service Account & API Credentials) has critical issues that must be addressed before sprint can be approved.

| Task | Status | Notes |
|------|--------|-------|
| 1.2 Terraform Bootstrap | ✅ PASS | Excellent modular architecture, proper security |
| 1.3 Service Account & API | ❌ FAIL | 4 critical/high issues - see below |
| 1.4 Folder Structure | ✅ PASS | Complete implementation, idempotent design |
| 1.5 Stakeholder Permissions | ✅ PASS | All criteria met |

---

## Critical Issues (Must Fix)

### Issue 1: Incorrect IAM Role Assignment
**Severity:** CRITICAL
**File:** `devrel-integration/terraform/modules/workspace/main.tf`
**Line:** 60

**Current:**
```hcl
role   = "roles/drive.file"
```

**Problem:** `roles/drive.file` is too restrictive. This role only allows the service account to manage files IT creates. It cannot:
- Create folders in shared drives
- Manage folder permissions
- Access folders created by other users

**Required:** Per acceptance criteria, should be `roles/drive.admin` or a custom role with folder management permissions.

**Impact:** Blocks Task 1.4 (Folder Structure) - cannot create the folder hierarchy without proper Drive admin permissions.

**Fix:**
```hcl
role   = "roles/drive.admin"
```

**Why This Matters:** The bot needs to create ~84 folders across the product hierarchy. Without admin permissions, `terraform apply` and the setup scripts will fail with permission denied errors.

---

### Issue 2: Missing Google Docs API IAM Role
**Severity:** HIGH
**File:** `devrel-integration/terraform/modules/workspace/main.tf`
**Lines:** 18-22 (API enabled), but no IAM grant

**Problem:** The Google Docs API is enabled (correct), but the service account has no IAM role granting access to use it.

**Current State:**
- ✅ `docs.googleapis.com` API enabled (line 18-22)
- ❌ No IAM role for Docs access

**Impact:** Service account cannot read/write Google Docs despite the API being enabled. The transformation pipeline (Sprint 2) will fail.

**Fix:** Add after line 62:
```hcl
resource "google_project_iam_member" "docs_editor" {
  project = var.gcp_project_id
  role    = "roles/docs.editor"
  member  = "serviceAccount:${google_service_account.onomancer_bot.email}"

  depends_on = [google_project_service.docs_api]
}
```

---

### Issue 3: Missing Domain-Wide Delegation Configuration
**Severity:** HIGH
**File:** `devrel-integration/terraform/modules/workspace/main.tf`

**Problem:** Acceptance criteria states: "Service account added to Google Workspace with domain-wide delegation (if needed)". This is not configured.

**Why It's Needed:**
- Service account needs to access Google Drive folders owned by the organization
- Without delegation, service account can only access files explicitly shared with it
- Required for programmatic folder creation in organizational Drive

**Fix:** This requires two steps:

1. **In Terraform** - Enable delegation on service account (add to service account resource):
```hcl
resource "google_service_account" "onomancer_bot" {
  account_id   = var.service_account_id
  display_name = var.service_account_display_name
  description  = "Service account for Onomancer Bot - manages Google Workspace documents"
  project      = var.gcp_project_id
}
```

2. **Manual Step (document in README):** Domain-wide delegation must be configured in Google Admin Console:
   - Go to Admin Console > Security > API Controls > Domain-wide Delegation
   - Add service account client ID
   - Grant scopes: `https://www.googleapis.com/auth/drive`, `https://www.googleapis.com/auth/documents`

**Note:** If domain-wide delegation is NOT needed for the current implementation approach, document WHY in the code comments and README.

---

### Issue 4: Incomplete Credential Storage Format
**Severity:** HIGH
**File:** `devrel-integration/terraform/modules/workspace/main.tf`
**Lines:** 77-81

**Problem:** Acceptance criteria requires credentials in `.env.local` format:
```bash
GOOGLE_SERVICE_ACCOUNT_EMAIL="onomancer-bot@{project-id}.iam.gserviceaccount.com"
GOOGLE_SERVICE_ACCOUNT_KEY_PATH="/path/to/service-account-key.json"
# OR
GOOGLE_SERVICE_ACCOUNT_KEY_JSON='{"type":"service_account",...}'
```

**Current:** Only raw JSON key file is stored at `secrets/google-service-account-key.json`

**Impact:** Bot application expects environment variables, not raw JSON file path. Integration will fail.

**Fix:** Add after line 81:
```hcl
resource "local_sensitive_file" "env_local" {
  filename        = "${path.root}/../secrets/.env.local"
  file_permission = "0600"
  content         = <<-EOT
# Generated by Terraform - DO NOT EDIT MANUALLY
# Service Account Credentials for Onomancer Bot

GOOGLE_SERVICE_ACCOUNT_EMAIL="${google_service_account.onomancer_bot.email}"
GOOGLE_SERVICE_ACCOUNT_KEY_PATH="${abspath(local_sensitive_file.service_account_key.filename)}"
EOT

  depends_on = [local_sensitive_file.service_account_key]
}
```

Also add to `.gitignore` if not already present:
```
secrets/.env.local
```

---

## Non-Critical Improvements (Recommended)

### 1. Add Verification Comments
**File:** `devrel-integration/terraform/modules/workspace/main.tf`

Consider adding comments explaining the IAM role choice:
```hcl
# IAM Role: roles/drive.admin
# Rationale: Bot needs to create folders, manage permissions, and organize
# documents across the entire product hierarchy. roles/drive.file is insufficient
# as it only allows file-level operations on files the service account creates.
```

### 2. Add Key Rotation Documentation
**File:** `devrel-integration/terraform/README.md`

Add a section on credential rotation:
```markdown
## Credential Rotation

To rotate the service account key:
1. Run `terraform taint google_service_account_key.onomancer_bot_key`
2. Run `terraform apply`
3. Update any systems using the old key
4. Old key is automatically invalidated
```

---

## What Was Done Well

1. **Modular Architecture** - Clean separation of workspace and monitoring concerns
2. **Security Basics** - File permissions (0600), sensitive outputs, gitignore configuration
3. **Documentation** - Comprehensive README with setup instructions
4. **API Enablement** - All 5 required APIs correctly enabled with proper dependencies
5. **State Management** - GCS backend with locking properly configured

---

## Next Steps

1. Fix all 4 critical/high issues above
2. Run `terraform validate` to verify changes
3. Update `docs/a2a/reviewer.md` with "Feedback Addressed" section describing fixes
4. Request re-review

---

## Files to Modify

| File | Changes Required |
|------|------------------|
| `terraform/modules/workspace/main.tf` | Fix IAM role, add Docs IAM, add .env.local generation |
| `terraform/README.md` | Document domain-wide delegation (if needed) or why not needed |
| `devrel-integration/.gitignore` | Ensure `secrets/.env.local` is excluded |

---

**Review Completed:** 2025-12-12
**Re-review Required:** Yes - after issues addressed
